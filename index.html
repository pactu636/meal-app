<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Family Meal Planner</title>
    <style>
        :root {
            --primary: #2ecc71;
            --bg: #f9f9f9;
            --card-bg: #ffffff;
            --text: #333333;
            --text-light: #777777;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        body { background-color: var(--bg); color: var(--text); padding-bottom: 70px; }
        header { background: var(--card-bg); padding: 20px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 10; }
        h1 { font-size: 1.5rem; color: var(--primary); }
        .container { padding: 20px; max-width: 600px; margin: 0 auto; }
        
        .tab-nav { position: fixed; bottom: 0; width: 100%; display: flex; background: var(--card-bg); box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 100; }
        .tab-btn { flex: 1; padding: 15px; border: none; background: none; font-size: 1rem; font-weight: bold; color: var(--text-light); cursor: pointer; }
        .tab-btn.active { color: var(--primary); border-top: 3px solid var(--primary); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .meal-time-header { font-size: 1.4rem; color: var(--text); margin: 30px 0 15px; padding-bottom: 5px; border-bottom: 2px solid var(--primary); }
        
        .meal-card { background: var(--card-bg); border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .meal-tag { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; margin-bottom: 10px; color: #fff; }
        .tag-meat { background: #e74c3c; } .tag-meatless { background: #2ecc71; } .tag-wildcard { background: #f39c12; } .tag-standard { background: #3498db; }
        .meal-title { font-size: 1.3rem; margin-bottom: 10px; }
        .meal-pic { width: 100%; height: 200px; object-fit: cover; border-radius: 8px; margin-bottom: 15px; background: #eee; }
        .section-title { font-size: 1.1rem; margin: 15px 0 5px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        ul, ol { margin-left: 20px; margin-bottom: 15px; color: #555; }
        li { margin-bottom: 5px; }
        
        .bulking-note { background: #e8f8f5; border-left: 4px solid var(--primary); padding: 10px; font-size: 0.9rem; margin-bottom: 15px; }

        .rating-box { display: flex; align-items: center; justify-content: space-between; margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; }
        .rating-slider { width: 60%; }
        .rating-value { font-weight: bold; color: var(--primary); }
        
        .shop-item { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; }
        .shop-item input[type="checkbox"] { margin-right: 15px; transform: scale(1.3); }
        .shop-item.checked span { text-decoration: line-through; color: var(--text-light); }

        .btn-action { display: block; width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: bold; margin-top: 20px; cursor: pointer; }
    </style>
</head>
<body>

    <header>
        <h1>üçΩÔ∏è Family Meal Planner</h1>
        <p id="date-display" style="font-size: 0.9rem; color: var(--text-light); margin-top: 5px;"></p>
    </header>

    <div class="container">
        <div id="meals-tab" class="tab-content active">
            <p style="margin-bottom: 10px; color: #666;">Your full day of meals. Ingredients are prioritized to use perishables early in the week.</p>
            <div id="meals-container"></div>
        </div>

        <div id="shopping-tab" class="tab-content">
            <p style="margin-bottom: 20px; color: #666;">Trader Joe's List (59th St). Automatically pulls ingredients for breakfast, lunch, snacks, and your top-rated dinner options.</p>
            <div id="shopping-list-container"></div>
            <button class="btn-action" onclick="app.generateNewWeek()">Generate Next Week's Plan</button>
        </div>
    </div>

    <nav class="tab-nav">
        <button class="tab-btn active" onclick="app.switchTab('meals')">Today's Meals</button>
        <button class="tab-btn" onclick="app.switchTab('shopping')">Shopping List</button>
    </nav>

    <script>
        // --- MEAL DATABASE ---
        const mealDatabase = [
            // BREAKFASTS
            { id: "b1", category: "breakfast", name: "Family Oatmeal Bar", perishability: 5, img: "https://images.unsplash.com/photo-1517673132405-a56a62b18caf?auto=format&fit=crop&w=500&q=60", ingredients: ["Rolled Oats", "Almond Milk", "Frozen Blueberries", "Chia Seeds"], recipe: ["Boil oats with milk.", "Stir in frozen berries until thawed.", "Top with chia seeds."], bulkNote: "For 19M: Eat 1.5 cups dry oats and stir in 2 large scoops of peanut butter while hot for massive calories." },
            
            // LUNCHES
            { id: "l1", category: "lunch", name: "Loaded Wraps & Fruit", perishability: 3, img: "https://images.unsplash.com/photo-1626700051175-6818013e1d4f?auto=format&fit=crop&w=500&q=60", ingredients: ["Large Tortillas", "Deli Turkey", "Hummus", "Spinach", "Apples"], recipe: ["Spread hummus on tortillas.", "Layer spinach and turkey (or extra hummus for vegan).", "Serve with sliced apples."], bulkNote: "For 19M: Use 3 tortillas. Skip turkey, double the hummus, and add a heavy drizzle of olive oil inside the wrap." },

            // SNACKS
            { id: "s1", category: "snack", name: "Rice Cakes & Nut Butter", perishability: 5, img: "https://images.unsplash.com/photo-1604085792782-8d92f276d7d8?auto=format&fit=crop&w=500&q=60", ingredients: ["Rice Cakes", "Peanut or Almond Butter", "Bananas"], recipe: ["Spread thick nut butter on rice cakes.", "Top with banana slices."], bulkNote: "For 19M: Eat 4 of these. Pure, clean carbs and healthy fats." },

            // DINNERS
            { id: "d1", category: "dinner", type: "meat", name: "Lemon Herb Chicken & Quinoa", perishability: 3, img: "https://images.unsplash.com/photo-1604908176997-125f25cc6f3d?auto=format&fit=crop&w=500&q=60", ingredients: ["3 lbs Chicken Breast", "2 cups Quinoa", "1 lb Green Beans", "Olive Oil"], recipe: ["Cook quinoa.", "Roast chicken and green beans at 400¬∞F for 25 mins."], bulkNote: "For 19M: Add 2 tbsp olive oil to your quinoa portion and walnuts for +400 calories." },
            { id: "d2", category: "dinner", type: "meatless", name: "Creamy Tomato Red Lentil Pasta", perishability: 4, img: "https://images.unsplash.com/photo-1551183053-bf91a1d81141?auto=format&fit=crop&w=500&q=60", ingredients: ["2 boxes TJ's Red Lentil Pasta", "2 jars Marinara Sauce", "1 tub Cashew Cream"], recipe: ["Boil pasta.", "Heat marinara, stir in cashew cream.", "Mix with pasta."], bulkNote: "For 19M: Eat a double portion. Red lentil pasta is a protein powerhouse." },
            { id: "d3", category: "dinner", type: "wildcard", name: "Soyaki Salmon Rice Bowls", perishability: 1, img: "https://images.unsplash.com/photo-1467003909585-2f8a72700288?auto=format&fit=crop&w=500&q=60", ingredients: ["5 Salmon Fillets", "TJ's Soyaki Sauce", "Jasmine Rice", "Broccoli", "Avocado"], recipe: ["Marinate salmon.", "Cook rice and broccoli.", "Bake salmon at 400¬∞F."], bulkNote: "For 19M: Swap salmon for baked Soyaki Tofu. Add a full half-avocado." }
        ];

        // --- APP LOGIC ---
        const app = {
            state: {
                currentWeek: [],
                ratings: JSON.parse(localStorage.getItem('mealRatings')) || {},
                shoppingList: JSON.parse(localStorage.getItem('shoppingList')) || []
            },

            init() {
                document.getElementById('date-display').innerText = new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
                
                const savedWeek = JSON.parse(localStorage.getItem('currentWeek'));
                const weekTimestamp = localStorage.getItem('weekTimestamp');
                const isExpired = weekTimestamp && (Date.now() - weekTimestamp > 7 * 24 * 60 * 60 * 1000);
                
                if (!savedWeek || isExpired) {
                    this.generateNewWeek();
                } else {
                    this.state.currentWeek = savedWeek;
                    this.renderTodayMeals();
                    this.renderShoppingList();
                }
            },

            generateNewWeek() {
                let weekPlan = [];
                for(let i=0; i<7; i++) {
                    weekPlan.push({
                        breakfast: this.pickMeal('breakfast'),
                        lunch: this.pickMeal('lunch'),
                        snack: this.pickMeal('snack'),
                        dinner: {
                            meat: this.pickMeal('dinner', 'meat'),
                            meatless: this.pickMeal('dinner', 'meatless'),
                            wildcard: this.pickMeal('dinner', 'wildcard')
                        }
                    });
                }

                weekPlan.sort((a, b) => {
                    let minA = Math.min(a.dinner.meat.perishability, a.dinner.meatless.perishability, a.dinner.wildcard.perishability, a.breakfast.perishability);
                    let minB = Math.min(b.dinner.meat.perishability, b.dinner.meatless.perishability, b.dinner.wildcard.perishability, b.breakfast.perishability);
                    return minA - minB; 
                });

                this.state.currentWeek = weekPlan;
                localStorage.setItem('currentWeek', JSON.stringify(weekPlan));
                localStorage.setItem('weekTimestamp', Date.now());

                this.generateShoppingList();
                this.renderTodayMeals();
                this.switchTab('meals');
                alert("New weekly plan generated! Includes Breakfast, Lunch, Dinner, and Snacks.");
            },

            pickMeal(category, type = null) {
                let options = mealDatabase.filter(m => m.category === category && (!type || m.type === type));
                if(options.length === 0) return null;

                let weightedOptions = [];
                options.forEach(meal => {
                    let rating = this.state.ratings[meal.id] || 5;
                    for(let i=0; i<rating; i++) weightedOptions.push(meal);
                });

                return weightedOptions[Math.floor(Math.random() * weightedOptions.length)];
            },

            generateShoppingList() {
                let list = [];
                this.state.currentWeek.forEach(day => {
                    // Get highest rated dinner to buy ingredients for
                    let bestDinner = [day.dinner.meat, day.dinner.meatless, day.dinner.wildcard].reduce((prev, current) => {
                        return (this.state.ratings[current.id] || 5) > (this.state.ratings[prev.id] || 5) ? current : prev;
                    });
                    
                    // Combine all ingredients for the day
                    let dailyIngredients = [...day.breakfast.ingredients, ...day.lunch.ingredients, ...day.snack.ingredients, ...bestDinner.ingredients];
                    
                    dailyIngredients.forEach(ing => {
                        if (!list.includes(ing)) list.push(ing);
                    });
                });

                this.state.shoppingList = list.map(item => ({ name: item, checked: false }));
                localStorage.setItem('shoppingList', JSON.stringify(this.state.shoppingList));
                this.renderShoppingList();
            },

            updateRating(id, val) {
                this.state.ratings[id] = parseInt(val);
                localStorage.setItem('mealRatings', JSON.stringify(this.state.ratings));
                document.getElementById('rating-val-' + id).innerText = val + '/10';
            },

            toggleShopItem(index) {
                this.state.shoppingList[index].checked = !this.state.shoppingList[index].checked;
                localStorage.setItem('shoppingList', JSON.stringify(this.state.shoppingList));
                this.renderShoppingList();
            },

            createMealHTML(meal, tagOverride = 'standard') {
                if(!meal) return '';
                let currentRating = this.state.ratings[meal.id] || 5;
                let tagClass = 'tag-' + tagOverride;
                let tagText = tagOverride.toUpperCase();

                return `
                    <div class="meal-card">
                        <span class="meal-tag ${tagClass}">${tagText}</span>
                        <h2 class="meal-title">${meal.name}</h2>
                        <img src="${meal.img}" class="meal-pic" alt="${meal.name}">
                        
                        <div class="bulking-note"><strong>Ethical Bulking Note:</strong><br> ${meal.bulkNote}</div>
                        
                        <h3 class="section-title">Ingredients</h3>
                        <ul>${meal.ingredients.map(i => `<li>${i}</li>`).join('')}</ul>
                        
                        <h3 class="section-title">Instructions</h3>
                        <ol>${meal.recipe.map(i => `<li>${i}</li>`).join('')}</ol>

                        <div class="rating-box">
                            <span>Rate this meal:</span>
                            <input type="range" min="1" max="10" value="${currentRating}" class="rating-slider" 
                                onchange="app.updateRating('${meal.id}', this.value)"
                                oninput="document.getElementById('rating-val-${meal.id}').innerText = this.value + '/10'">
                            <span class="rating-value" id="rating-val-${meal.id}">${currentRating}/10</span>
                        </div>
                    </div>
                `;
            },

            renderTodayMeals() {
                const container = document.getElementById('meals-container');
                const todayOptions = this.state.currentWeek[new Date().getDay()];
                if(!todayOptions) return;

                let html = `
                    <h2 class="meal-time-header">üåÖ Breakfast</h2>
                    ${this.createMealHTML(todayOptions.breakfast)}

                    <h2 class="meal-time-header">ü•™ Lunch</h2>
                    ${this.createMealHTML(todayOptions.lunch)}

                    <h2 class="meal-time-header">üçé Snack</h2>
                    ${this.createMealHTML(todayOptions.snack)}

                    <h2 class="meal-time-header">üçΩÔ∏è Dinner Options (Pick 1)</h2>
                    ${this.createMealHTML(todayOptions.dinner.meat, 'meat')}
                    ${this.createMealHTML(todayOptions.dinner.meatless, 'meatless')}
                    ${this.createMealHTML(todayOptions.dinner.wildcard, 'wildcard')}
                `;
                container.innerHTML = html;
            },

            renderShoppingList() {
                const container = document.getElementById('shopping-list-container');
                container.innerHTML = this.state.shoppingList.map((item, index) => `
                    <label class="shop-item ${item.checked ? 'checked' : ''}">
                        <input type="checkbox" ${item.checked ? 'checked' : ''} onchange="app.toggleShopItem(${index})">
                        <span>${item.name}</span>
                    </label>
                `).join('');
            },

            switchTab(tab) {
                document.querySelectorAll('.tab-content, .tab-btn').forEach(el => el.classList.remove('active'));
                document.getElementById(tab + '-tab').classList.add('active');
                event.currentTarget.classList.add('active');
            }
        };

        app.init();
    </script>
</body>
</html>
