<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Family Meal Planner</title>
    <style>
        :root {
            --primary: #2ecc71;
            --bg: #f9f9f9;
            --card-bg: #ffffff;
            --text: #333333;
            --text-light: #777777;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        body { background-color: var(--bg); color: var(--text); padding-bottom: 70px; }
        header { background: var(--card-bg); padding: 20px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 10; }
        h1 { font-size: 1.5rem; color: var(--primary); }
        .container { padding: 20px; max-width: 600px; margin: 0 auto; }
        
        /* Tabs */
        .tab-nav { position: fixed; bottom: 0; width: 100%; display: flex; background: var(--card-bg); box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 100; }
        .tab-btn { flex: 1; padding: 15px; border: none; background: none; font-size: 1rem; font-weight: bold; color: var(--text-light); cursor: pointer; }
        .tab-btn.active { color: var(--primary); border-top: 3px solid var(--primary); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Meal Cards */
        .meal-card { background: var(--card-bg); border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .meal-tag { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; margin-bottom: 10px; color: #fff; }
        .tag-meat { background: #e74c3c; } .tag-meatless { background: #2ecc71; } .tag-wildcard { background: #f39c12; }
        .meal-title { font-size: 1.3rem; margin-bottom: 10px; }
        .meal-pic { width: 100%; height: 200px; object-fit: cover; border-radius: 8px; margin-bottom: 15px; background: #eee; }
        .section-title { font-size: 1.1rem; margin: 15px 0 5px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        ul, ol { margin-left: 20px; margin-bottom: 15px; color: #555; }
        li { margin-bottom: 5px; }
        
        /* Bulking Note */
        .bulking-note { background: #e8f8f5; border-left: 4px solid var(--primary); padding: 10px; font-size: 0.9rem; margin-bottom: 15px; }

        /* Rating System */
        .rating-box { display: flex; align-items: center; justify-content: space-between; margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; }
        .rating-slider { width: 60%; }
        .rating-value { font-weight: bold; color: var(--primary); }
        
        /* Shopping List */
        .shop-item { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; }
        .shop-item input[type="checkbox"] { margin-right: 15px; transform: scale(1.3); }
        .shop-item.checked span { text-decoration: line-through; color: var(--text-light); }

        .btn-action { display: block; width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: bold; margin-top: 20px; cursor: pointer; }
    </style>
</head>
<body>

    <header>
        <h1>üçΩÔ∏è Family Meal Planner</h1>
        <p id="date-display" style="font-size: 0.9rem; color: var(--text-light); margin-top: 5px;"></p>
    </header>

    <div class="container">
        <div id="meals-tab" class="tab-content active">
            <p style="margin-bottom: 20px; color: #666;">Here are your 3 daily options. Ingredients are ordered to use perishables (like fresh greens/fish) early in the week.</p>
            <div id="meals-container"></div>
        </div>

        <div id="shopping-tab" class="tab-content">
            <p style="margin-bottom: 20px; color: #666;">Trader Joe's List (59th St). Automatically generated based on your top-rated selections for the week.</p>
            <div id="shopping-list-container"></div>
            <button class="btn-action" onclick="app.generateNewWeek()">Generate Next Week's Plan</button>
        </div>
    </div>

    <nav class="tab-nav">
        <button class="tab-btn active" onclick="app.switchTab('meals')">Today's Meals</button>
        <button class="tab-btn" onclick="app.switchTab('shopping')">Shopping List</button>
    </nav>

    <script>
        // --- MEAL DATABASE ---
        // perishability: 1 (use immediately, e.g., delicate greens, fresh fish) to 5 (pantry staples)
        const mealDatabase = [
            {
                id: "m1", type: "meat", name: "Lemon Herb Chicken & Quinoa", perishability: 3, 
                img: "https://images.unsplash.com/photo-1604908176997-125f25cc6f3d?auto=format&fit=crop&w=500&q=60",
                ingredients: ["3 lbs Chicken Breast", "2 cups Quinoa", "1 lb Green Beans", "2 Lemons", "Olive Oil", "Oregano"],
                recipe: ["Cook quinoa according to package.", "Marinate chicken in olive oil, lemon juice, and oregano.", "Roast chicken and green beans at 400¬∞F for 25 mins."],
                bulkNote: "For 19M: Add 2 tbsp olive oil to your quinoa portion and a large handful of walnuts for +400 clean, plant-based calories."
            },
            {
                id: "m2", type: "meatless", name: "Creamy Tomato Red Lentil Pasta", perishability: 4,
                img: "https://images.unsplash.com/photo-1551183053-bf91a1d81141?auto=format&fit=crop&w=500&q=60",
                ingredients: ["2 boxes TJ's Red Lentil Pasta", "2 jars Marinara Sauce", "1 bag Fresh Spinach", "1 tub Cashew Cream (or heavy cream)"],
                recipe: ["Boil pasta.", "Heat marinara, stir in cashew cream for richness.", "Fold in fresh spinach until wilted, then mix with pasta."],
                bulkNote: "For 19M: Red lentil pasta is a massive protein cheat code. Eat a double portion for ~40g plant protein."
            },
            {
                id: "m3", type: "wildcard", name: "Soyaki Salmon Rice Bowls", perishability: 1,
                img: "https://images.unsplash.com/photo-1467003909585-2f8a72700288?auto=format&fit=crop&w=500&q=60",
                ingredients: ["5 Salmon Fillets", "1 bottle TJ's Soyaki Sauce", "3 cups Jasmine Rice", "1 bag Broccoli Florets", "1 Avocado"],
                recipe: ["Marinate salmon in Soyaki.", "Cook rice.", "Steam broccoli.", "Bake salmon at 400¬∞F for 12-15 mins. Serve in bowls topped with avocado."],
                bulkNote: "For 19M: Swap salmon for 1 block of Extra Firm Tofu (pressed, cubed, baked in Soyaki). Add a full half-avocado for healthy fats."
            },
            {
                id: "m4", type: "meat", name: "Turkey Meatball Sweet Potato Mash", perishability: 3,
                img: "https://images.unsplash.com/photo-1529042410759-befb1204b468?auto=format&fit=crop&w=500&q=60",
                ingredients: ["2 packs TJ's Turkey Meatballs", "4 large Sweet Potatoes", "1 bag Brussels Sprouts", "Butter/Vegan Butter"],
                recipe: ["Boil and mash sweet potatoes.", "Roast halved Brussels sprouts with olive oil at 400¬∞F for 20 mins.", "Heat meatballs in sauce or plain, serve over mash."],
                bulkNote: "For 19M: Eat meatballs if flexible, otherwise sub with 1 can of chickpeas roasted with the sprouts. Heavy on the sweet potato for complex carbs."
            },
            {
                id: "m5", type: "meatless", name: "Black Bean & Sweet Corn Quesadillas", perishability: 4,
                img: "https://images.unsplash.com/photo-1615870216519-2f9fa575fa5c?auto=format&fit=crop&w=500&q=60",
                ingredients: ["2 packs Large Tortillas", "2 cans Black Beans (rinsed)", "1 bag Frozen Roasted Corn", "1 pack Mexican Blend Cheese (or Vegan Shreds)", "Mild Salsa"],
                recipe: ["Mash half the black beans, mix with whole beans and corn.", "Spread mixture and cheese on tortillas.", "Grill in a pan until golden and crispy."],
                bulkNote: "For 19M: Load yours with vegan shreds and add a massive side of guacamole (avocado) for dense caloric intake."
            },
            {
                id: "m6", type: "wildcard", name: "Mediterranean Hummus Flatbreads", perishability: 2,
                img: "https://images.unsplash.com/photo-1541518763669-27fef04b14ea?auto=format&fit=crop&w=500&q=60",
                ingredients: ["2 packs TJ's Flatbread/Naan", "2 tubs Hummus", "1 pack Cherry Tomatoes", "1 Cucumber", "Kalamata Olives", "Feta Cheese (Optional)"],
                recipe: ["Toast flatbreads.", "Spread a thick layer of hummus.", "Top with diced cucumber, halved tomatoes, and olives."],
                bulkNote: "For 19M: Hummus is highly caloric and great for bulking. Eat 1.5 flatbreads heavily loaded with hummus and olive oil."
            },
            {
                id: "m7", type: "meat", name: "One-Pan Chicken Sausage & Veggies", perishability: 3,
                img: "https://images.unsplash.com/photo-1604908176997-125f25cc6f3d?auto=format&fit=crop&w=500&q=60", // Placeholder
                ingredients: ["2 packs TJ's Chicken Sausage", "2 Bell Peppers", "1 Red Onion", "1 lb Baby Potatoes"],
                recipe: ["Chop everything into bite-sized pieces.", "Toss with olive oil, salt, and pepper.", "Roast on a sheet pan at 400¬∞F for 30 minutes."],
                bulkNote: "For 19M: Swap chicken sausage for TJ's Vegan Italian Sausage. Eat an extra serving of olive-oil soaked potatoes."
            },
            {
                id: "m8", type: "meatless", name: "Peanut Butter Tofu Stir-fry", perishability: 2,
                img: "https://images.unsplash.com/photo-1546069901-ba9599a7e63c?auto=format&fit=crop&w=500&q=60",
                ingredients: ["2 blocks Extra Firm Tofu", "1 bag Stir-fry Veggie Mix", "Peanut Butter", "Soy Sauce", "Udon Noodles"],
                recipe: ["Press and cube tofu, pan-fry until crispy.", "Mix 1/2 cup peanut butter with soy sauce and warm water for sauce.", "Stir fry veggies, add noodles, tofu, and sauce."],
                bulkNote: "For 19M: This is your ultimate bulking meal. The peanut butter and tofu combo is incredibly calorie and protein-dense."
            },
            {
                id: "m9", type: "wildcard", name: "Gnocchi with Pesto and Peas", perishability: 3,
                img: "https://images.unsplash.com/photo-1551183053-bf91a1d81141?auto=format&fit=crop&w=500&q=60", // Placeholder
                ingredients: ["3 packs TJ's Cauliflower Gnocchi", "1 jar Vegan Pesto", "1 bag Frozen Peas", "Pine Nuts"],
                recipe: ["Pan-fry gnocchi in oil until crispy (don't boil!).", "Thaw peas under warm water.", "Toss gnocchi with pesto, peas, and top with pine nuts."],
                bulkNote: "For 19M: Pine nuts and pesto (olive oil/nuts) are great for adding ethical weight. Eat a large portion."
            }
        ];

        // --- APP LOGIC ---
        const app = {
            state: {
                currentWeek: [], // Array of daily options
                ratings: JSON.parse(localStorage.getItem('mealRatings')) || {},
                shoppingList: JSON.parse(localStorage.getItem('shoppingList')) || []
            },

            init() {
                document.getElementById('date-display').innerText = new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
                
                // Check if we have a current week plan saved
                const savedWeek = JSON.parse(localStorage.getItem('currentWeek'));
                const weekTimestamp = localStorage.getItem('weekTimestamp');
                
                // If no plan, or plan is older than 7 days, generate new
                const isExpired = weekTimestamp && (Date.now() - weekTimestamp > 7 * 24 * 60 * 60 * 1000);
                
                if (!savedWeek || isExpired) {
                    this.generateNewWeek();
                } else {
                    this.state.currentWeek = savedWeek;
                    this.renderTodayMeals();
                    this.renderShoppingList();
                }
            },

            generateNewWeek() {
                // We pick 7 meat, 7 meatless, 7 wildcards. 
                // For a full year app, you'd have a bigger database. Here we loop/reuse based on ratings.
                let weekPlan = [];
                
                for(let i=0; i<7; i++) {
                    let dailyMeals = {
                        meat: this.pickMeal('meat'),
                        meatless: this.pickMeal('meatless'),
                        wildcard: this.pickMeal('wildcard')
                    };
                    weekPlan.push(dailyMeals);
                }

                // Sort the days so highly perishable meals (perishability 1 or 2) happen earlier in the week.
                // We base a day's perishability on the most perishable option in that day.
                weekPlan.sort((a, b) => {
                    let minA = Math.min(a.meat.perishability, a.meatless.perishability, a.wildcard.perishability);
                    let minB = Math.min(b.meat.perishability, b.meatless.perishability, b.wildcard.perishability);
                    return minA - minB; 
                });

                this.state.currentWeek = weekPlan;
                localStorage.setItem('currentWeek', JSON.stringify(weekPlan));
                localStorage.setItem('weekTimestamp', Date.now());

                this.generateShoppingList();
                this.renderTodayMeals();
                this.switchTab('meals');
                alert("New weekly plan generated! Perishables sorted for early in the week.");
            },

            pickMeal(type) {
                // Filter by type
                let options = mealDatabase.filter(m => m.type === type);
                
                // Weight selection by rating (default rating is 5)
                let weightedOptions = [];
                options.forEach(meal => {
                    let rating = this.state.ratings[meal.id] || 5;
                    // Add meal to array 'rating' number of times (higher rating = more likely to be picked)
                    for(let i=0; i<rating; i++) {
                        weightedOptions.push(meal);
                    }
                });

                let randomIndex = Math.floor(Math.random() * weightedOptions.length);
                return weightedOptions[randomIndex];
            },

            generateShoppingList() {
                // To prevent waste, we assume you buy ingredients for the highest-rated option of each day
                let list = [];
                this.state.currentWeek.forEach(day => {
                    let bestMeal = [day.meat, day.meatless, day.wildcard].reduce((prev, current) => {
                        let prevRating = this.state.ratings[prev.id] || 5;
                        let currRating = this.state.ratings[current.id] || 5;
                        return (currRating > prevRating) ? current : prev;
                    });
                    
                    bestMeal.ingredients.forEach(ing => {
                        if (!list.includes(ing)) list.push(ing);
                    });
                });

                this.state.shoppingList = list.map(item => ({ name: item, checked: false }));
                localStorage.setItem('shoppingList', JSON.stringify(this.state.shoppingList));
                this.renderShoppingList();
            },

            updateRating(id, val) {
                this.state.ratings[id] = parseInt(val);
                localStorage.setItem('mealRatings', JSON.stringify(this.state.ratings));
                document.getElementById('rating-val-' + id).innerText = val + '/10';
            },

            toggleShopItem(index) {
                this.state.shoppingList[index].checked = !this.state.shoppingList[index].checked;
                localStorage.setItem('shoppingList', JSON.stringify(this.state.shoppingList));
                this.renderShoppingList();
            },

            renderTodayMeals() {
                const container = document.getElementById('meals-container');
                // Get 'today' based on day of week (0-6)
                const dayIndex = new Date().getDay(); 
                const todayOptions = this.state.currentWeek[dayIndex];

                if(!todayOptions) return;

                let html = '';
                ['meat', 'meatless', 'wildcard'].forEach(type => {
                    let meal = todayOptions[type];
                    let currentRating = this.state.ratings[meal.id] || 5;
                    let tagClass = 'tag-' + type;

                    html += `
                        <div class="meal-card">
                            <span class="meal-tag ${tagClass}">${type.toUpperCase()}</span>
                            <h2 class="meal-title">${meal.name}</h2>
                            <img src="${meal.img}" class="meal-pic" alt="${meal.name}">
                            
                            <div class="bulking-note">
                                <strong>Ethical Bulking Note:</strong><br> ${meal.bulkNote}
                            </div>

                            <h3 class="section-title">Ingredients</h3>
                            <ul>${meal.ingredients.map(i => `<li>${i}</li>`).join('')}</ul>

                            <h3 class="section-title">Instructions</h3>
                            <ol>${meal.recipe.map(i => `<li>${i}</li>`).join('')}</ol>

                            <div class="rating-box">
                                <span>Rate this meal:</span>
                                <input type="range" min="1" max="10" value="${currentRating}" class="rating-slider" 
                                    onchange="app.updateRating('${meal.id}', this.value)"
                                    oninput="document.getElementById('rating-val-${meal.id}').innerText = this.value + '/10'">
                                <span class="rating-value" id="rating-val-${meal.id}">${currentRating}/10</span>
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html;
            },

            renderShoppingList() {
                const container = document.getElementById('shopping-list-container');
                let html = '';
                this.state.shoppingList.forEach((item, index) => {
                    html += `
                        <label class="shop-item ${item.checked ? 'checked' : ''}">
                            <input type="checkbox" ${item.checked ? 'checked' : ''} onchange="app.toggleShopItem(${index})">
                            <span>${item.name}</span>
                        </label>
                    `;
                });
                container.innerHTML = html;
            },

            switchTab(tab) {
                document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
                
                document.getElementById(tab + '-tab').classList.add('active');
                event.currentTarget.classList.add('active');
            }
        };

        // Boot app
        app.init();
    </script>
</body>
</html>
