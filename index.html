<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Family Meal Planner</title>
    <style>
        :root {
            --primary: #2ecc71;
            --bg: #f9f9f9;
            --card-bg: #ffffff;
            --text: #333333;
            --text-light: #777777;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        body { background-color: var(--bg); color: var(--text); padding-bottom: 70px; }
        header { background: var(--card-bg); padding: 20px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 10; }
        h1 { font-size: 1.5rem; color: var(--primary); }
        .container { padding: 20px; max-width: 600px; margin: 0 auto; }
        
        .tab-nav { position: fixed; bottom: 0; width: 100%; display: flex; background: var(--card-bg); box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 100; }
        .tab-btn { flex: 1; padding: 15px; border: none; background: none; font-size: 1rem; font-weight: bold; color: var(--text-light); cursor: pointer; }
        .tab-btn.active { color: var(--primary); border-top: 3px solid var(--primary); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .meal-time-header { font-size: 1.4rem; color: var(--text); margin: 30px 0 15px; padding-bottom: 5px; border-bottom: 2px solid var(--primary); }
        
        .meal-card { background: var(--card-bg); border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .meal-tag { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; margin-bottom: 10px; color: #fff; }
        .tag-meat { background: #e74c3c; } .tag-meatless { background: #2ecc71; } .tag-wildcard { background: #f39c12; } .tag-standard { background: #3498db; }
        .meal-title { font-size: 1.3rem; margin-bottom: 10px; }
        .meal-pic { width: 100%; height: 200px; object-fit: cover; border-radius: 8px; margin-bottom: 15px; background: #eee; }
        .section-title { font-size: 1.1rem; margin: 15px 0 5px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        ul, ol { margin-left: 20px; margin-bottom: 15px; color: #555; }
        li { margin-bottom: 5px; }
        
        .bulking-note { background: #e8f8f5; border-left: 4px solid var(--primary); padding: 10px; font-size: 0.9rem; margin-bottom: 15px; }

        .rating-box { display: flex; align-items: center; justify-content: space-between; margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; }
        .rating-slider { width: 60%; }
        .rating-value { font-weight: bold; color: var(--primary); }
        
        .shop-item { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; }
        .shop-item input[type="checkbox"] { margin-right: 15px; transform: scale(1.3); }
        .shop-item.checked span { text-decoration: line-through; color: var(--text-light); }

        .btn-action { display: block; width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: bold; margin-top: 20px; cursor: pointer; }
    </style>
</head>
<body>

    <header>
        <h1>üçΩÔ∏è Family Meal Planner</h1>
        <p id="date-display" style="font-size: 0.9rem; color: var(--text-light); margin-top: 5px;"></p>
    </header>

    <div class="container">
        <div id="meals-tab" class="tab-content active">
            <p style="margin-bottom: 10px; color: #666;">Your full day of meals. Ingredients are prioritized to use perishables early in the week.</p>
            <div id="meals-container"></div>
        </div>

        <div id="shopping-tab" class="tab-content">
            <p style="margin-bottom: 20px; color: #666;">Trader Joe's List (59th St). Automatically pulls ingredients for breakfast, lunch, snacks, and your top-rated dinner options.</p>
            <div id="shopping-list-container"></div>
            <button class="btn-action" onclick="app.generateNewWeek()">Generate Next Week's Plan</button>
        </div>
    </div>

    <nav class="tab-nav">
        <button class="tab-btn active" onclick="app.switchTab('meals')">Today's Meals</button>
        <button class="tab-btn" onclick="app.switchTab('shopping')">Shopping List</button>
    </nav>

    <script>
        // --- MEAL DATABASE ---
        const mealDatabase = [
            // BREAKFASTS
            { id: "b1", category: "breakfast", name: "Family Oatmeal Bar", perishability: 5, img: "https://images.unsplash.com/photo-1517673132405-a56a62b18caf?auto=format&fit=crop&w=500&q=60", ingredients: ["Rolled Oats", "Almond Milk", "Frozen Blueberries", "Chia Seeds"], recipe: ["Boil oats with milk.", "Stir in frozen berries until thawed.", "Top with chia seeds."], bulkNote: "For 19M: Eat 1.5 cups dry oats and stir in 2 large scoops of peanut butter while hot for massive calories." },
            
            // LUNCHES
            { id: "l1", category: "lunch", name: "Loaded Wraps & Fruit", perishability: 3, img: "https://images.unsplash.com/photo-1626700051175-6818013e1d4f?auto=format&fit=crop&w=500&q=60", ingredients: ["Large Tortillas", "Deli Turkey", "Hummus", "Spinach", "Apples"], recipe: ["Spread hummus on tortillas.", "Layer spinach and turkey (or extra hummus for vegan).", "Serve with sliced apples."], bulkNote: "For 19M: Use 3 tortillas. Skip turkey, double the hummus, and add a heavy drizzle of olive oil inside the wrap." },

            // SNACKS
            { id: "s1", category: "snack", name: "Rice Cakes & Nut Butter", perishability: 5, img: "https://images.unsplash.com/photo-1604085792782-8d92f276d7d8?auto=format&fit=crop&w=500&q=60", ingredients: ["Rice Cakes", "Peanut or Almond Butter", "Bananas"], recipe: ["Spread thick nut butter on rice cakes.", "Top with banana slices."], bulkNote: "For 19M: Eat 4 of these. Pure, clean carbs and healthy fats." },

            // DINNERS
            { id: "d1", category: "dinner", type: "meat", name: "Lemon Herb Chicken & Quinoa", perishability: 3, img: "https://images.unsplash.com/photo-1604908176997-125f25cc6f3d?auto=format&fit=crop&w=500&q=60", ingredients: ["3 lbs Chicken Breast", "2 cups Quinoa", "1 lb Green Beans", "Olive Oil"], recipe: ["Cook quinoa.", "Roast chicken and green beans at 400¬∞F for 25 mins."], bulkNote: "For 19M: Add 2 tbsp olive oil to your quinoa portion and walnuts for +400 calories." },
            { id: "d2", category: "dinner", type: "meatless", name: "Creamy Tomato Red Lentil Pasta", perishability: 4, img: "https://images.unsplash.com/photo-1551183053-bf91a1d81141?auto=format&fit=crop&w=500&q=60", ingredients: ["2 boxes TJ's Red Lentil Pasta", "2 jars Marinara Sauce", "1 tub Cashew Cream"], recipe: ["Boil pasta.", "Heat marinara, stir in cashew cream.", "Mix with pasta."], bulkNote: "For 19M: Eat a double portion. Red lentil pasta is a protein powerhouse." },
            { id: "d3", category: "dinner", type: "wildcard", name: "Soyaki Salmon Rice Bowls", perishability: 1, img: "https://images.unsplash.com/photo-1467003909585-2f8a72700288?auto=format&fit=crop&w=500&q=60", ingredients: ["5 Salmon Fillets", "TJ's Soyaki Sauce", "Jasmine Rice", "Broccoli", "Avocado"], recipe: ["Marinate salmon.", "Cook rice and broccoli.", "Bake salmon at 400¬∞F."], bulkNote: "For 19M: Swap salmon for baked Soyaki Tofu. Add a full half-avocado." }
            // --- NEW BREAKFASTS ---
            { id: "b2", category: "breakfast", name: "Avocado & Egg Sourdough Toast", perishability: 2, img: "https://images.unsplash.com/photo-1541519227354-08fa5d50c44d?auto=format&fit=crop&w=500&q=60", ingredients: ["TJ's Sourdough Bread", "Avocados", "Pasture-Raised Eggs", "Everything But The Bagel Seasoning"], recipe: ["Toast sourdough slices.", "Mash avocado and spread on toast.", "Top with fried or poached eggs and seasoning."], bulkNote: "For 19M: Eat 3 thick slices. Drizzle a tablespoon of high-quality extra virgin olive oil over the top for an easy, clean +120 calories." },
            { id: "b3", category: "breakfast", name: "Greek Yogurt & Granola Parfaits", perishability: 3, img: "https://images.unsplash.com/photo-1484723091791-c0e7e8c80084?auto=format&fit=crop&w=500&q=60", ingredients: ["Whole Milk Greek Yogurt", "TJ's Almond Butter Granola", "Strawberries", "Honey"], recipe: ["Layer yogurt, granola, and sliced strawberries in bowls.", "Drizzle generously with honey."], bulkNote: "For 19M: Use full-fat Greek yogurt. Mix 2 tablespoons of chia seeds into your yogurt and add an extra handful of walnuts." },
            { id: "b4", category: "breakfast", name: "Protein Banana Pancakes", perishability: 4, img: "https://images.unsplash.com/photo-1528207776546-32248a4f104e?auto=format&fit=crop&w=500&q=60", ingredients: ["TJ's Buttermilk Pancake Mix", "Bananas", "Maple Syrup", "Walnuts"], recipe: ["Mash 2 bananas into the pancake batter.", "Cook on a buttered skillet.", "Top with syrup and crushed walnuts."], bulkNote: "For 19M: Smear a thick layer of peanut butter between every pancake in your stack. Liquid calories (syrup) and dense fats (PB) are your best friends here." },
            { id: "b5", category: "breakfast", name: "Overnight Chia & Oat Jars", perishability: 5, img: "https://images.unsplash.com/photo-1517672651691-24622a91b550?auto=format&fit=crop&w=500&q=60", ingredients: ["Rolled Oats", "Chia Seeds", "Oat Milk", "Maple Syrup", "Cinnamon"], recipe: ["Mix oats, a spoonful of chia seeds, oat milk, and maple syrup in jars.", "Leave in fridge overnight.", "Eat cold or warm up."], bulkNote: "For 19M: Use 1 cup of oats per jar. Mix in a scoop of plant-based protein powder and a heavy dollop of almond butter before eating." },

            // --- NEW LUNCHES ---
            { id: "l2", category: "lunch", name: "Mediterranean Quinoa Bowls", perishability: 3, img: "https://images.unsplash.com/photo-1512621776951-a57141f2eefd?auto=format&fit=crop&w=500&q=60", ingredients: ["Quinoa", "Cucumbers", "Cherry Tomatoes", "TJ's Vegan Feta", "Canned Chickpeas", "Lemon Juice"], recipe: ["Cook quinoa and let cool slightly.", "Chop veggies.", "Toss everything with olive oil, lemon juice, salt, and pepper."], bulkNote: "For 19M: Double your chickpea portion for plant protein. Drench your bowl in 2-3 tbsp of olive oil and tahini dressing." },
            { id: "l3", category: "lunch", name: "Black Bean & Corn Quesadillas", perishability: 4, img: "https://images.unsplash.com/photo-1615486171448-4fdcb7212006?auto=format&fit=crop&w=500&q=60", ingredients: ["Flour Tortillas", "Canned Black Beans", "Frozen Roasted Corn", "Shredded Mexican Blend Cheese", "Salsa"], recipe: ["Rinse beans and mix with thawed corn.", "Fill tortillas with cheese and bean mixture.", "Cook on a skillet until golden, serve with salsa."], bulkNote: "For 19M: Make two massive quesadillas. Mash a whole avocado to use as a dip to get those healthy, dense fats." },
            { id: "l4", category: "lunch", name: "Soba Noodle Peanut Salad", perishability: 4, img: "https://images.unsplash.com/photo-1552611052-33e04de081de?auto=format&fit=crop&w=500&q=60", ingredients: ["Soba Noodles", "TJ's Spicy Peanut Vinaigrette (mild)", "Shelled Edamame", "Shredded Carrots"], recipe: ["Boil soba noodles, drain, and rinse with cold water.", "Toss with edamame, carrots, and peanut dressing."], bulkNote: "For 19M: Eat a huge portion of noodles (carbs). Add an extra handful of crushed roasted peanuts on top for easy calories." },
            { id: "l5", category: "lunch", name: "Pesto Caprese Sandwiches", perishability: 2, img: "https://images.unsplash.com/photo-1528735602780-2552fd46c7af?auto=format&fit=crop&w=500&q=60", ingredients: ["Ciabatta Rolls", "Fresh Mozzarella", "Tomatoes", "TJ's Vegan Kale Pesto"], recipe: ["Slice rolls and spread pesto generously.", "Layer sliced mozzarella and tomatoes.", "Press or toast slightly if desired."], bulkNote: "For 19M: Eat 2 full sandwiches. If you want to skip dairy, swap the mozzarella for thick slices of seasoned, pan-fried tofu." },

            // --- NEW SNACKS ---
            { id: "s2", category: "snack", name: "TJ's Omega Trail Mix", perishability: 5, img: "https://images.unsplash.com/photo-1599599811450-2b1b36585196?auto=format&fit=crop&w=500&q=60", ingredients: ["TJ's Omega Trek Mix"], recipe: ["Open bag.", "Eat."], bulkNote: "For 19M: Nuts are the ultimate ethical bulking cheat code. Keep a bag on your desk and eat a few handfuls throughout the day. It adds up to 500+ calories effortlessly." },
            { id: "s3", category: "snack", name: "Pita & Thick Hummus", perishability: 3, img: "https://images.unsplash.com/photo-1577003833610-8588827363cd?auto=format&fit=crop&w=500&q=60", ingredients: ["Pita Bread", "TJ's Mediterranean Hummus", "Carrots"], recipe: ["Warm the pita bread.", "Dip in hummus along with carrots."], bulkNote: "For 19M: Skip the carrots, focus on the pita bread for carbs. Pour a puddle of olive oil into the center of your hummus bowl before dipping." },
            { id: "s4", category: "snack", name: "Apple & Almond Butter Rings", perishability: 4, img: "https://images.unsplash.com/photo-1560806887-1e4cd0b6bc6c?auto=format&fit=crop&w=500&q=60", ingredients: ["Apples", "Almond Butter", "Cinnamon"], recipe: ["Slice apples horizontally into rings (remove seeds).", "Spread almond butter thickly on each ring.", "Dust with cinnamon."], bulkNote: "For 19M: Eat 2 whole apples. Don't be shy with the almond butter‚Äîlayer it on as thick as the apple slice itself." },
            { id: "s5", category: "snack", name: "Protein Smoothies", perishability: 1, img: "https://images.unsplash.com/photo-1553530666-ba11a7da3888?auto=format&fit=crop&w=500&q=60", ingredients: ["Frozen Mango", "Bananas", "Spinach", "Almond Milk"], recipe: ["Blend all ingredients until smooth."], bulkNote: "For 19M: Add 3 tablespoons of hemp hearts and 2 tablespoons of peanut butter to the blender. Drinking your calories is the easiest way to bulk without feeling stuffed." },

            // --- NEW DINNERS (MEAT) ---
            { id: "dm1", category: "dinner", type: "meat", name: "Sheet Pan Chicken Sausage & Peppers", perishability: 2, img: "https://images.unsplash.com/photo-1606851185331-1e9a2b53bd7e?auto=format&fit=crop&w=500&q=60", ingredients: ["TJ's Roasted Garlic Chicken Sausage", "Bell Peppers", "Red Onions", "Sweet Potatoes"], recipe: ["Chop veggies and slice sausage.", "Toss with olive oil, salt, and pepper.", "Roast on a sheet pan at 400¬∞F for 30 mins."], bulkNote: "For 19M: Swap the chicken sausage for TJ's Italian Field Roast (vegan sausage). Eat a huge pile of the roasted sweet potatoes for complex carbs." },
            { id: "dm2", category: "dinner", type: "meat", name: "Turkey Meatball Spaghetti", perishability: 4, img: "https://images.unsplash.com/photo-1563379926898-05f4575a45d8?auto=format&fit=crop&w=500&q=60", ingredients: ["Frozen Turkey Meatballs", "Spaghetti", "TJ's Basil Marinara Sauce", "Parmesan Cheese"], recipe: ["Boil pasta.", "Simmer meatballs in the marinara sauce until heated through.", "Combine and top with cheese."], bulkNote: "For 19M: Swap your meatballs for TJ's Meatless Meatballs. Drizzle 2 tbsp of olive oil directly onto your pasta portion before adding sauce." },
            { id: "dm3", category: "dinner", type: "meat", name: "Chicken Shawarma Rice Bowls", perishability: 2, img: "https://images.unsplash.com/photo-1548946526-f69e2424cf45?auto=format&fit=crop&w=500&q=60", ingredients: ["TJ's Marinated Shawarma Chicken Thighs", "Basmati Rice", "Tzatziki", "Cucumbers"], recipe: ["Cook rice.", "Bake or pan-fry the shawarma chicken.", "Serve over rice with diced cucumbers and a heavy dollop of tzatziki."], bulkNote: "For 19M: You can eat the chicken if you strictly source it well, or swap for pan-fried chickpeas coated in shawarma spices. Double the rice." },
            { id: "dm4", category: "dinner", type: "meat", name: "Ground Turkey Tacos", perishability: 3, img: "https://images.unsplash.com/photo-1551504734-5ee1c4a1479b?auto=format&fit=crop&w=500&q=60", ingredients: ["Ground Turkey", "TJ's Taco Seasoning", "Hard Taco Shells", "Shredded Lettuce", "Salsa"], recipe: ["Brown the turkey and mix in seasoning with a splash of water.", "Serve in shells with lettuce, salsa, and cheese."], bulkNote: "For 19M: Use black beans or lentils instead of turkey. Add a huge scoop of guacamole and eat 4-5 tacos." },

            // --- NEW DINNERS (MEATLESS) ---
            { id: "dml1", category: "dinner", type: "meatless", name: "Sweet Potato & Black Bean Chili", perishability: 4, img: "https://images.unsplash.com/photo-1551224673-10bc49d2112b?auto=format&fit=crop&w=500&q=60", ingredients: ["Sweet Potatoes", "Canned Black Beans", "Canned Diced Tomatoes", "Vegetable Broth", "Chili Powder"], recipe: ["Cube sweet potatoes and simmer with beans, tomatoes, broth, and seasoning for 30 mins until soft.", "Serve with tortilla chips."], bulkNote: "For 19M: Serve your chili over a massive bed of brown rice. Add half an avocado on top. Excellent clean fuel." },
            { id: "dml2", category: "dinner", type: "meatless", name: "Pesto Tortellini & Greens", perishability: 3, img: "https://images.unsplash.com/photo-1473093295043-cdd812d0e601?auto=format&fit=crop&w=500&q=60", ingredients: ["TJ's Cheese Tortellini", "TJ's Vegan Kale Pesto", "Fresh Spinach", "Cherry Tomatoes"], recipe: ["Boil tortellini.", "In the last minute of boiling, toss in the spinach to wilt.", "Drain and toss with pesto and halved tomatoes."], bulkNote: "For 19M: Tortellini is very calorie-dense. Eat a large portion and add a handful of pine nuts or walnuts to the dish." },
            { id: "dml3", category: "dinner", type: "meatless", name: "Crispy Tofu & Broccoli Stir-Fry", perishability: 2, img: "https://images.unsplash.com/photo-1546069901-ba9599a7e63c?auto=format&fit=crop&w=500&q=60", ingredients: ["Extra Firm Tofu", "Broccoli Florets", "Jasmine Rice", "Soy Sauce", "Sesame Oil"], recipe: ["Press and cube tofu. Pan-fry in sesame oil until crispy.", "Steam or stir-fry broccoli.", "Toss tofu and broccoli in soy sauce and serve over rice."], bulkNote: "For 19M: Fry your tofu in a generous amount of oil (avocado or sesame). Eat 2 cups of cooked rice with it." },
            { id: "dml4", category: "dinner", type: "meatless", name: "Hearty Lentil Shepherd's Pie", perishability: 3, img: "https://images.unsplash.com/photo-1588166524941-3bf61a9c41db?auto=format&fit=crop&w=500&q=60", ingredients: ["TJ's Steamed Lentils", "Frozen Peas and Carrots", "Mashed Potatoes (or make fresh)"], recipe: ["Heat lentils with peas and carrots in a skillet.", "Transfer to a baking dish, top with mashed potatoes.", "Bake at 375¬∞F until the potatoes are slightly golden."], bulkNote: "For 19M: Mix a generous amount of vegan butter or olive oil into your portion of the mashed potatoes." },

            // --- NEW DINNERS (WILDCARD) ---
            { id: "dw1", category: "dinner", type: "wildcard", name: "Shrimp Scampi Linguine", perishability: 1, img: "https://images.unsplash.com/photo-1555949258-eb67b1ef0ceb?auto=format&fit=crop&w=500&q=60", ingredients: ["Frozen Argentinian Red Shrimp", "Linguine", "Garlic", "Butter (or Vegan Butter)", "Lemon"], recipe: ["Boil pasta.", "Saut√© garlic in butter, add thawed shrimp and cook until pink.", "Toss with pasta, lemon juice, and parsley."], bulkNote: "For 19M: If avoiding shrimp, swap for cannellini beans saut√©ed in garlic and oil. Eat a massive plate of pasta." },
            { id: "dw2", category: "dinner", type: "wildcard", name: "Margherita Pita Pizzas", perishability: 3, img: "https://images.unsplash.com/photo-1565299624946-b28f40a0ae38?auto=format&fit=crop&w=500&q=60", ingredients: ["Pita Bread", "Pizza Sauce", "Fresh Mozzarella", "Fresh Basil"], recipe: ["Spread sauce on pitas, top with cheese.", "Bake at 400¬∞F for 10 mins until bubbly.", "Top with fresh basil."], bulkNote: "For 19M: Eat 3-4 pitas. Drizzle extra virgin olive oil over the pizzas right when they come out of the oven." },
            { id: "dw3", category: "dinner", type: "wildcard", name: "Gnocchi with Brown Butter & Sage", perishability: 4, img: "https://images.unsplash.com/photo-1551183053-bf91a1d81141?auto=format&fit=crop&w=500&q=60", ingredients: ["TJ's Potato Gnocchi", "Butter (or Vegan Butter)", "Fresh Sage", "Parmesan"], recipe: ["Boil gnocchi until they float.", "Melt butter in a pan until lightly browned, toss in sage leaves.", "Toss gnocchi in the butter and top with cheese."], bulkNote: "For 19M: Gnocchi is incredibly dense in carbs. Have a huge bowl and roast some chickpeas on the side for protein." },
            { id: "dw4", category: "dinner", type: "wildcard", name: "Baked Mahi-Mahi Tacos", perishability: 1, img: "https://images.unsplash.com/photo-1512838243191-e81e8c148564?auto=format&fit=crop&w=500&q=60", ingredients: ["Frozen Mahi-Mahi Fillets", "Corn Tortillas", "Cabbage Slaw", "Limes", "Cilantro"], recipe: ["Bake fish at 400¬∞F until flaky.", "Flake fish into warm tortillas.", "Top with slaw, lime juice, and cilantro."], bulkNote: "For 19M: If avoiding fish, use crumbled tempeh pan-fried in taco spices. Add half a sliced avocado to your tacos." }
        ];

        // --- APP LOGIC ---
        const app = {
            state: {
                currentWeek: [],
                ratings: JSON.parse(localStorage.getItem('mealRatings')) || {},
                shoppingList: JSON.parse(localStorage.getItem('shoppingList')) || []
            },

            init() {
                document.getElementById('date-display').innerText = new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
                
                const savedWeek = JSON.parse(localStorage.getItem('currentWeek'));
                const weekTimestamp = localStorage.getItem('weekTimestamp');
                const isExpired = weekTimestamp && (Date.now() - weekTimestamp > 7 * 24 * 60 * 60 * 1000);
                
                if (!savedWeek || isExpired) {
                    this.generateNewWeek();
                } else {
                    this.state.currentWeek = savedWeek;
                    this.renderTodayMeals();
                    this.renderShoppingList();
                }
            },

            generateNewWeek() {
                let weekPlan = [];
                for(let i=0; i<7; i++) {
                    weekPlan.push({
                        breakfast: this.pickMeal('breakfast'),
                        lunch: this.pickMeal('lunch'),
                        snack: this.pickMeal('snack'),
                        dinner: {
                            meat: this.pickMeal('dinner', 'meat'),
                            meatless: this.pickMeal('dinner', 'meatless'),
                            wildcard: this.pickMeal('dinner', 'wildcard')
                        }
                    });
                }

                weekPlan.sort((a, b) => {
                    let minA = Math.min(a.dinner.meat.perishability, a.dinner.meatless.perishability, a.dinner.wildcard.perishability, a.breakfast.perishability);
                    let minB = Math.min(b.dinner.meat.perishability, b.dinner.meatless.perishability, b.dinner.wildcard.perishability, b.breakfast.perishability);
                    return minA - minB; 
                });

                this.state.currentWeek = weekPlan;
                localStorage.setItem('currentWeek', JSON.stringify(weekPlan));
                localStorage.setItem('weekTimestamp', Date.now());

                this.generateShoppingList();
                this.renderTodayMeals();
                this.switchTab('meals');
                alert("New weekly plan generated! Includes Breakfast, Lunch, Dinner, and Snacks.");
            },

            pickMeal(category, type = null) {
                let options = mealDatabase.filter(m => m.category === category && (!type || m.type === type));
                if(options.length === 0) return null;

                let weightedOptions = [];
                options.forEach(meal => {
                    let rating = this.state.ratings[meal.id] || 5;
                    for(let i=0; i<rating; i++) weightedOptions.push(meal);
                });

                return weightedOptions[Math.floor(Math.random() * weightedOptions.length)];
            },

            generateShoppingList() {
                let list = [];
                this.state.currentWeek.forEach(day => {
                    // Get highest rated dinner to buy ingredients for
                    let bestDinner = [day.dinner.meat, day.dinner.meatless, day.dinner.wildcard].reduce((prev, current) => {
                        return (this.state.ratings[current.id] || 5) > (this.state.ratings[prev.id] || 5) ? current : prev;
                    });
                    
                    // Combine all ingredients for the day
                    let dailyIngredients = [...day.breakfast.ingredients, ...day.lunch.ingredients, ...day.snack.ingredients, ...bestDinner.ingredients];
                    
                    dailyIngredients.forEach(ing => {
                        if (!list.includes(ing)) list.push(ing);
                    });
                });

                this.state.shoppingList = list.map(item => ({ name: item, checked: false }));
                localStorage.setItem('shoppingList', JSON.stringify(this.state.shoppingList));
                this.renderShoppingList();
            },

            updateRating(id, val) {
                this.state.ratings[id] = parseInt(val);
                localStorage.setItem('mealRatings', JSON.stringify(this.state.ratings));
                document.getElementById('rating-val-' + id).innerText = val + '/10';
            },

            toggleShopItem(index) {
                this.state.shoppingList[index].checked = !this.state.shoppingList[index].checked;
                localStorage.setItem('shoppingList', JSON.stringify(this.state.shoppingList));
                this.renderShoppingList();
            },

            createMealHTML(meal, tagOverride = 'standard') {
                if(!meal) return '';
                let currentRating = this.state.ratings[meal.id] || 5;
                let tagClass = 'tag-' + tagOverride;
                let tagText = tagOverride.toUpperCase();

                return `
                    <div class="meal-card">
                        <span class="meal-tag ${tagClass}">${tagText}</span>
                        <h2 class="meal-title">${meal.name}</h2>
                        <img src="${meal.img}" class="meal-pic" alt="${meal.name}">
                        
                        <div class="bulking-note"><strong>Ethical Bulking Note:</strong><br> ${meal.bulkNote}</div>
                        
                        <h3 class="section-title">Ingredients</h3>
                        <ul>${meal.ingredients.map(i => `<li>${i}</li>`).join('')}</ul>
                        
                        <h3 class="section-title">Instructions</h3>
                        <ol>${meal.recipe.map(i => `<li>${i}</li>`).join('')}</ol>

                        <div class="rating-box">
                            <span>Rate this meal:</span>
                            <input type="range" min="1" max="10" value="${currentRating}" class="rating-slider" 
                                onchange="app.updateRating('${meal.id}', this.value)"
                                oninput="document.getElementById('rating-val-${meal.id}').innerText = this.value + '/10'">
                            <span class="rating-value" id="rating-val-${meal.id}">${currentRating}/10</span>
                        </div>
                    </div>
                `;
            },

            renderTodayMeals() {
                const container = document.getElementById('meals-container');
                const todayOptions = this.state.currentWeek[new Date().getDay()];
                if(!todayOptions) return;

                let html = `
                    <h2 class="meal-time-header">üåÖ Breakfast</h2>
                    ${this.createMealHTML(todayOptions.breakfast)}

                    <h2 class="meal-time-header">ü•™ Lunch</h2>
                    ${this.createMealHTML(todayOptions.lunch)}

                    <h2 class="meal-time-header">üçé Snack</h2>
                    ${this.createMealHTML(todayOptions.snack)}

                    <h2 class="meal-time-header">üçΩÔ∏è Dinner Options (Pick 1)</h2>
                    ${this.createMealHTML(todayOptions.dinner.meat, 'meat')}
                    ${this.createMealHTML(todayOptions.dinner.meatless, 'meatless')}
                    ${this.createMealHTML(todayOptions.dinner.wildcard, 'wildcard')}
                `;
                container.innerHTML = html;
            },

            renderShoppingList() {
                const container = document.getElementById('shopping-list-container');
                container.innerHTML = this.state.shoppingList.map((item, index) => `
                    <label class="shop-item ${item.checked ? 'checked' : ''}">
                        <input type="checkbox" ${item.checked ? 'checked' : ''} onchange="app.toggleShopItem(${index})">
                        <span>${item.name}</span>
                    </label>
                `).join('');
            },

            switchTab(tab) {
                document.querySelectorAll('.tab-content, .tab-btn').forEach(el => el.classList.remove('active'));
                document.getElementById(tab + '-tab').classList.add('active');
                event.currentTarget.classList.add('active');
            }
        };

        app.init();
    </script>
</body>
</html>
